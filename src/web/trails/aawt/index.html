<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AAWT 2025 - GPX Tools</title>
  <link rel="stylesheet" href="../../styles.css">
  <style>
    .trail-header {
      margin-bottom: 2rem;
    }
    .trail-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1rem;
    }
    .trail-meta-item {
      background: var(--bg-secondary, #f5f5f5);
      padding: 0.5rem 1rem;
      border-radius: 4px;
    }
    .trail-meta-item strong {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      opacity: 0.7;
    }
    .trail-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 2rem 0;
    }
    .stat-card {
      background: var(--bg-secondary, #f5f5f5);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }
    .stat-card .value {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .stat-card .label {
      font-size: 0.875rem;
      opacity: 0.7;
    }
    .elevation-profile {
      width: 100%;
      height: 200px;
      background: var(--bg-secondary, #f5f5f5);
      border-radius: 8px;
      margin: 2rem 0;
      position: relative;
    }
    .elevation-profile canvas {
      width: 100%;
      height: 100%;
    }
    .waypoints-table-wrapper {
      overflow-x: auto;
      margin: 1rem 0;
    }
    .waypoints-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    .waypoints-table th,
    .waypoints-table td {
      padding: 0.5rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color, #ddd);
    }
    .waypoints-table th {
      background: var(--bg-secondary, #f5f5f5);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    .waypoints-table td.numeric {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .waypoints-table tr:hover {
      background: var(--bg-secondary, #f5f5f5);
    }
    .waypoints-table tr.highlight-town {
      background: #fff3e0;
    }
    .waypoints-table tr.highlight-town:hover {
      background: #ffe0b2;
    }
    .waypoints-table tr.highlight-resupply {
      background: #e8f5e9;
    }
    .waypoints-table tr.highlight-resupply:hover {
      background: #c8e6c9;
    }
    .waypoint-type {
      font-size: 0.7rem;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      background: var(--accent-light, #e3f2fd);
      white-space: nowrap;
    }
    .waypoint-type.type-town {
      background: #ffcc80;
    }
    .waypoint-type.type-hut {
      background: #b39ddb;
    }
    .waypoint-type.type-campsite {
      background: #a5d6a7;
    }
    .waypoint-type.type-water {
      background: #81d4fa;
    }
    .waypoint-type.type-water-tank {
      background: #80cbc4;
    }
    .waypoint-type.type-mountain {
      background: #bcaaa4;
    }
    .waypoints-list {
      list-style: none;
      padding: 0;
    }
    .waypoints-list li {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border-color, #ddd);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .waypoints-list li:last-child {
      border-bottom: none;
    }
    .poi-section {
      margin-top: 2rem;
    }
    .poi-category {
      margin-bottom: 1.5rem;
    }
    .poi-category h4 {
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .poi-count {
      font-size: 0.875rem;
      opacity: 0.7;
      font-weight: normal;
    }
    /* Inline variant rows in waypoints table */
    .variant-row {
      background: var(--bg-secondary, #f8f9fa);
    }
    .variant-row.type-alternate {
      background: #fff8e1;
      border-left: 3px solid #ff9800;
    }
    .variant-row.type-side-trip {
      background: #fce4ec;
      border-left: 3px solid #9c27b0;
    }
    .variant-marker {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .variant-icon {
      font-size: 1.1rem;
    }
    .variant-action {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-left: 0.25rem;
    }
    .variant-inline-stats {
      font-size: 0.85rem;
      color: var(--text-secondary, #666);
    }
    .variant-stats-cell {
      text-align: left !important;
    }
    .variant-type-badge {
      display: inline-block;
      font-size: 0.65rem;
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      text-transform: uppercase;
      font-weight: 600;
    }
    .variant-type-badge.type-alternate {
      background: #fff3e0;
      color: #e65100;
    }
    .variant-type-badge.type-side-trip {
      background: #f3e5f5;
      color: #7b1fa2;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .section-header h3 {
      margin: 0;
    }
    .export-btn {
      padding: 0.5rem 1rem;
      background: var(--accent-color, #2196F3);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.2s;
    }
    .export-btn:hover:not(:disabled) {
      background: var(--accent-hover, #1976D2);
    }
    .export-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container trail-data">
    <header>
      <nav class="breadcrumb">
        <a href="../../">Home</a> / <a href="../">Trails</a> / <span>AAWT</span>
      </nav>
    </header>

    <section class="panel active">
      <div class="trail-header">
        <h1>AAWT 2025</h1>
        <div class="trail-meta">
          <div class="trail-meta-item">
            <strong>Region</strong>
            Unknown
          </div>
          <div class="trail-meta-item">
            <strong>Difficulty</strong>
            unknown
          </div>
          <div class="trail-meta-item">
            <strong>Best Months</strong>
            Year-round
          </div>
        </div>
      </div>

      <div class="trail-stats">
        <div class="stat-card">
          <div class="value" id="distance">--</div>
          <div class="label">Distance (km)</div>
        </div>
        <div class="stat-card">
          <div class="value" id="ascent">--</div>
          <div class="label">Total Ascent (m)</div>
        </div>
        <div class="stat-card">
          <div class="value" id="descent">--</div>
          <div class="label">Total Descent (m)</div>
        </div>
        <div class="stat-card">
          <div class="value" id="points">--</div>
          <div class="label">Track Points</div>
        </div>
      </div>

      <h3>Elevation Profile</h3>
      <div class="elevation-profile">
        <canvas id="elevation-canvas"></canvas>
      </div>

      <div class="section-header">
        <h3>Waypoints</h3>
        <button id="export-btn" class="export-btn" disabled>Export CSV</button>
      </div>
      <div class="waypoints-table-wrapper" id="waypoints-container">
        <p>Loading waypoints...</p>
      </div>

      <div class="poi-section" id="poi-section" hidden>
        <h3>Points of Interest</h3>
        <div id="poi-categories"></div>
      </div>
    </section>

    <footer>
      <p><a href="../">Back to Trail List</a></p>
    </footer>
  </div>

  <script type="module">
    const TRAIL_ID = 'aawt';
    const MONTH_NAMES = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    async function loadTrailData() {
      try {
        const response = await fetch(`/data/generated/${TRAIL_ID}.json`);
        if (!response.ok) throw new Error('Trail data not found');
        return await response.json();
      } catch (error) {
        console.error('Failed to load trail data:', error);
        return null;
      }
    }

    function updateStats(trail) {
      document.getElementById('distance').textContent = trail.track.totalDistance.toFixed(1);
      document.getElementById('ascent').textContent = Math.round(trail.track.totalAscent);
      document.getElementById('descent').textContent = Math.round(trail.track.totalDescent);
      document.getElementById('points').textContent = trail.track.points.length.toLocaleString();
    }

    function drawElevationProfile(points) {
      const canvas = document.getElementById('elevation-canvas');
      const ctx = canvas.getContext('2d');
      const rect = canvas.getBoundingClientRect();

      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

      if (points.length === 0) return;

      const elevations = points.map(p => p.ele);
      const distances = points.map(p => p.dist);
      const minEle = Math.min(...elevations);
      const maxEle = Math.max(...elevations);
      const maxDist = Math.max(...distances);

      const padding = { top: 20, right: 20, bottom: 30, left: 50 };
      const width = rect.width - padding.left - padding.right;
      const height = rect.height - padding.top - padding.bottom;

      // Draw grid
      ctx.strokeStyle = '#ddd';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = padding.top + (height / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(padding.left + width, y);
        ctx.stroke();
      }

      // Draw profile
      ctx.beginPath();
      ctx.strokeStyle = '#2196F3';
      ctx.lineWidth = 2;

      points.forEach((point, i) => {
        const x = padding.left + (point.dist / maxDist) * width;
        const y = padding.top + height - ((point.ele - minEle) / (maxEle - minEle)) * height;

        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      ctx.stroke();

      // Fill under curve
      ctx.lineTo(padding.left + width, padding.top + height);
      ctx.lineTo(padding.left, padding.top + height);
      ctx.closePath();
      ctx.fillStyle = 'rgba(33, 150, 243, 0.1)';
      ctx.fill();

      // Draw labels
      ctx.fillStyle = '#666';
      ctx.font = '12px system-ui, sans-serif';
      ctx.textAlign = 'right';
      ctx.fillText(`${Math.round(maxEle)}m`, padding.left - 5, padding.top + 10);
      ctx.fillText(`${Math.round(minEle)}m`, padding.left - 5, padding.top + height);

      ctx.textAlign = 'center';
      ctx.fillText('0 km', padding.left, padding.top + height + 20);
      ctx.fillText(`${maxDist.toFixed(0)} km`, padding.left + width, padding.top + height + 20);
    }

    function renderWaypoints(waypoints, alternates, sideTrips) {
      const container = document.getElementById('waypoints-container');

      if (!waypoints || waypoints.length === 0) {
        container.innerHTML = '<p>No waypoints defined</p>';
        return;
      }

      // Resupply keywords to detect resupply points
      const resupplyKeywords = ['grocer', 'market', 'foodland', 'iga', 'wool', 'coles', 'general', 'servo'];

      function isResupply(wp) {
        const text = ((wp.name || '') + ' ' + (wp.description || '')).toLowerCase();
        return resupplyKeywords.some(kw => text.includes(kw));
      }

      function getRowClass(wp) {
        if (wp.type === 'town') return 'highlight-town';
        if (isResupply(wp)) return 'highlight-resupply';
        return '';
      }

      function getTypeClass(type) {
        const typeMap = {
          'town': 'type-town',
          'hut': 'type-hut',
          'campsite': 'type-campsite',
          'water': 'type-water',
          'water-tank': 'type-water-tank',
          'mountain': 'type-mountain'
        };
        return typeMap[type] || '';
      }

      // Build a combined list of waypoints and variant markers, sorted by distance
      const allVariants = [...(alternates || []), ...(sideTrips || [])];
      const tableRows = [];

      // Add waypoints
      for (const wp of waypoints) {
        tableRows.push({
          rowType: 'waypoint',
          distance: wp.totalDistance ?? 0,
          data: wp
        });
      }

      // Add variant start/end markers
      for (const variant of allVariants) {
        if (variant.startDistance != null) {
          tableRows.push({
            rowType: 'variant-start',
            distance: variant.startDistance,
            data: variant
          });
        }
        // For alternates, add rejoin marker
        if (variant.type === 'alternate' && variant.endDistance != null) {
          tableRows.push({
            rowType: 'variant-end',
            distance: variant.endDistance,
            data: variant
          });
        }
      }

      // Sort by distance along route
      tableRows.sort((a, b) => a.distance - b.distance);

      function renderWaypointRow(wp) {
        return `
          <tr class="${getRowClass(wp)}">
            <td>${wp.name || 'Unnamed'}</td>
            <td><span class="waypoint-type ${getTypeClass(wp.type)}">${wp.type || 'waypoint'}</span></td>
            <td class="numeric">${wp.elevation ?? '-'}</td>
            <td class="numeric">${wp.distance?.toFixed(1) ?? '-'}</td>
            <td class="numeric">${wp.totalDistance?.toFixed(1) ?? '-'}</td>
            <td class="numeric">${wp.ascent ?? '-'}</td>
            <td class="numeric">${wp.descent ?? '-'}</td>
            <td class="numeric">${wp.totalAscent ?? '-'}</td>
            <td class="numeric">${wp.totalDescent ?? '-'}</td>
          </tr>
        `;
      }

      function renderVariantRow(variant, isStart) {
        const typeClass = variant.type === 'alternate' ? 'type-alternate' : 'type-side-trip';
        const typeLabel = variant.type === 'alternate' ? 'Alternate' : 'Side Trip';
        const actionLabel = isStart
          ? (variant.type === 'alternate' ? 'branches' : 'starts')
          : 'rejoins';
        const distance = isStart ? variant.startDistance : variant.endDistance;

        return `
          <tr class="variant-row ${typeClass}">
            <td colspan="2">
              <span class="variant-marker ${typeClass}">
                <span class="variant-icon">${isStart ? '↗' : '↘'}</span>
                <strong>${variant.name}</strong>
                <span class="variant-action">${actionLabel} here</span>
              </span>
            </td>
            <td colspan="3" class="variant-stats-cell">
              <span class="variant-inline-stats">
                ${variant.distance} km · +${variant.elevation?.ascent || 0}m / -${variant.elevation?.descent || 0}m
              </span>
            </td>
            <td class="numeric">${distance?.toFixed(1) ?? '-'}</td>
            <td colspan="3">
              <span class="variant-type-badge ${typeClass}">${typeLabel}</span>
            </td>
          </tr>
        `;
      }

      const tableHtml = `
        <table class="waypoints-table">
          <thead>
            <tr>
              <th>Location</th>
              <th>Type</th>
              <th>Elev (m)</th>
              <th>Dist (km)</th>
              <th>Total (km)</th>
              <th>Gain (m)</th>
              <th>Loss (m)</th>
              <th>Total Gain</th>
              <th>Total Loss</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows.map(row => {
              if (row.rowType === 'waypoint') {
                return renderWaypointRow(row.data);
              } else if (row.rowType === 'variant-start') {
                return renderVariantRow(row.data, true);
              } else {
                return renderVariantRow(row.data, false);
              }
            }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = tableHtml;
    }

    function exportDatasheet(trail) {
      const { config, track, waypoints, alternates, sideTrips } = trail;

      // Build CSV content
      const lines = [];

      // Header with trail info
      lines.push(`# ${config.name} - Trail Datasheet`);
      lines.push(`# Region: ${config.region}`);
      lines.push(`# Total Distance: ${track.totalDistance.toFixed(1)} km`);
      lines.push(`# Total Ascent: ${Math.round(track.totalAscent)} m`);
      lines.push(`# Total Descent: ${Math.round(track.totalDescent)} m`);
      lines.push(`# Generated: ${new Date().toISOString().split('T')[0]}`);
      lines.push('');

      // Waypoints table header
      lines.push('Location,Type,Elevation (m),Distance (km),Total (km),Gain (m),Loss (m),Total Gain (m),Total Loss (m),Notes');

      // Add waypoints
      for (const wp of waypoints || []) {
        const row = [
          `"${(wp.name || 'Unnamed').replace(/"/g, '""')}"`,
          wp.type || 'waypoint',
          wp.elevation ?? '',
          wp.distance?.toFixed(1) ?? '',
          wp.totalDistance?.toFixed(1) ?? '',
          wp.ascent ?? '',
          wp.descent ?? '',
          wp.totalAscent ?? '',
          wp.totalDescent ?? '',
          `"${(wp.description || '').replace(/"/g, '""')}"`
        ];
        lines.push(row.join(','));
      }

      // Add alternates section if present
      if (alternates && alternates.length > 0) {
        lines.push('');
        lines.push('# Alternate Routes');
        lines.push('Name,Type,Distance (km),Ascent (m),Descent (m),Start Distance (km),End Distance (km)');
        for (const alt of alternates) {
          const row = [
            `"${(alt.name || 'Unnamed').replace(/"/g, '""')}"`,
            alt.type || 'alternate',
            alt.distance ?? '',
            alt.elevation?.ascent ?? '',
            alt.elevation?.descent ?? '',
            alt.startDistance?.toFixed(1) ?? '',
            alt.endDistance?.toFixed(1) ?? ''
          ];
          lines.push(row.join(','));
        }
      }

      // Add side trips section if present
      if (sideTrips && sideTrips.length > 0) {
        lines.push('');
        lines.push('# Side Trips');
        lines.push('Name,Type,Distance (km),Ascent (m),Descent (m),Start Distance (km)');
        for (const trip of sideTrips) {
          const row = [
            `"${(trip.name || 'Unnamed').replace(/"/g, '""')}"`,
            trip.type || 'side-trip',
            trip.distance ?? '',
            trip.elevation?.ascent ?? '',
            trip.elevation?.descent ?? '',
            trip.startDistance?.toFixed(1) ?? ''
          ];
          lines.push(row.join(','));
        }
      }

      const csvContent = lines.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `${config.id || 'trail'}-datasheet.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function renderPOIs(pois) {
      if (!pois || pois.length === 0) return;

      const section = document.getElementById('poi-section');
      const container = document.getElementById('poi-categories');
      section.removeAttribute('hidden');

      // Group by category
      const grouped = {};
      for (const poi of pois) {
        if (!grouped[poi.category]) grouped[poi.category] = [];
        grouped[poi.category].push(poi);
      }

      const categoryLabels = {
        water: 'Water Sources',
        camping: 'Camping',
        resupply: 'Resupply',
        transport: 'Transport',
        emergency: 'Emergency'
      };

      container.innerHTML = Object.entries(grouped).map(([category, items]) => `
        <div class="poi-category">
          <h4>${categoryLabels[category] || category} <span class="poi-count">(${items.length})</span></h4>
          <ul class="waypoints-list">
            ${items.slice(0, 10).map(poi => `
              <li>
                <span>${poi.name || poi.tags?.amenity || poi.tags?.tourism || 'Unnamed'}</span>
                <span class="waypoint-type">${(poi.distanceAlongTrail || 0).toFixed(1)} km</span>
              </li>
            `).join('')}
            ${items.length > 10 ? `<li><em>...and ${items.length - 10} more</em></li>` : ''}
          </ul>
        </div>
      `).join('');
    }

    async function init() {
      const trail = await loadTrailData();
      if (!trail) {
        document.querySelector('.panel').innerHTML = '<p>Failed to load trail data.</p>';
        return;
      }

      updateStats(trail);
      drawElevationProfile(trail.track.points);
      renderWaypoints(trail.waypoints, trail.alternates, trail.sideTrips);
      renderPOIs(trail.pois);

      // Enable export button
      const exportBtn = document.getElementById('export-btn');
      exportBtn.disabled = false;
      exportBtn.addEventListener('click', () => exportDatasheet(trail));

      // Redraw on resize
      window.addEventListener('resize', () => drawElevationProfile(trail.track.points));
    }

    init();
  </script>
</body>
</html>
